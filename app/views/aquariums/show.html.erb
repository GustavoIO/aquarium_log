<div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-2">
  <div>
    <h1 class="mb-1"><%= @aquarium.name %></h1>
    <% if @aquarium.description.present? %>
      <p class="text-muted mb-0"><%= @aquarium.description %></p>
    <% end %>
  </div>
  <div class="flex-shrink-0">
    <%= link_to "Edit", edit_aquarium_path(@aquarium), class: "btn btn-outline-secondary btn-sm" %>
  </div>
</div>

<!-- Chart Section -->
<div class="card mb-4">
  <div class="card-body">
    <canvas id="parameterChart" height="100"></canvas>
  </div>
  <div class="card-footer param-tabs">
    <div class="btn-group flex-wrap" role="group" aria-label="Parameter selection">
      <button type="button" class="btn btn-outline-primary parameter-tab active btn-sm" data-param="ph">pH</button>
      <button type="button" class="btn btn-outline-primary parameter-tab btn-sm" data-param="kh">KH</button>
      <button type="button" class="btn btn-outline-primary parameter-tab btn-sm" data-param="gh">GH</button>
      <button type="button" class="btn btn-outline-primary parameter-tab btn-sm" data-param="nitrates">NO3</button>
      <button type="button" class="btn btn-outline-primary parameter-tab btn-sm" data-param="phosphates">PO4</button>
    </div>
  </div>
</div>

<!-- Measurements Table -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0 fs-6">Measurements</h5>
    <%= link_to "+ Add", new_aquarium_measurement_path(@aquarium), class: "btn btn-primary btn-sm" %>
  </div>
  <div class="card-body">
    <% if @measurements.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Date</th>
              <th class="text-center param-col" data-param="ph">pH</th>
              <th class="text-center param-col" data-param="kh">KH</th>
              <th class="text-center param-col" data-param="gh">GH</th>
              <th class="text-center param-col" data-param="nitrates">NO3</th>
              <th class="text-center param-col" data-param="phosphates">PO4</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @measurements.each do |measurement| %>
              <tr>
                <td class="text-nowrap"><%= measurement.measured_at.strftime("%m/%d %H:%M") %></td>
                <td class="text-center param-col" data-param="ph"><%= measurement.ph || "-" %></td>
                <td class="text-center param-col" data-param="kh"><%= measurement.kh || "-" %></td>
                <td class="text-center param-col" data-param="gh"><%= measurement.gh || "-" %></td>
                <td class="text-center param-col" data-param="nitrates"><%= measurement.nitrates || "-" %></td>
                <td class="text-center param-col" data-param="phosphates"><%= measurement.phosphates || "-" %></td>
                <td class="text-end text-nowrap">
                  <div class="d-flex gap-1 justify-content-end">
                    <%= link_to "Edit", edit_aquarium_measurement_path(@aquarium, measurement), class: "btn btn-outline-secondary btn-sm" %>
                    <%= button_to "Del", aquarium_measurement_path(@aquarium, measurement), method: :delete,
                        class: "btn btn-outline-danger btn-sm",
                        form: { class: "d-inline" },
                        data: { turbo_confirm: "Are you sure?" } %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted mb-0">No measurements yet. Add your first measurement to start tracking!</p>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('parameterChart').getContext('2d');
  let chart = null;
  const aquariumId = <%= @aquarium.id %>;

  const paramColors = {
    ph: 'rgb(75, 192, 192)',
    kh: 'rgb(54, 162, 235)',
    gh: 'rgb(255, 159, 64)',
    nitrates: 'rgb(255, 99, 132)',
    phosphates: 'rgb(153, 102, 255)'
  };

  const paramLabels = {
    ph: 'pH',
    kh: 'KH (dKH)',
    gh: 'GH (dGH)',
    nitrates: 'Nitrates (mg/l)',
    phosphates: 'Phosphates (mg/l)'
  };

  function loadChart(param) {
    fetch(`/aquariums/${aquariumId}/chart_data?param=${param}`)
      .then(response => response.json())
      .then(data => {
        if (chart) {
          chart.destroy();
        }

        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels,
            datasets: [{
              label: paramLabels[param],
              data: data.values,
              borderColor: paramColors[param],
              backgroundColor: 'transparent',
              fill: false,
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true, position: 'top' }
            },
            scales: {
              y: { beginAtZero: param !== 'ph' }
            }
          }
        });

        // Highlight column
        document.querySelectorAll('.param-col').forEach(col => {
          col.classList.remove('highlight-column');
          if (col.dataset.param === param) {
            col.classList.add('highlight-column');
          }
        });
      });
  }

  // Tab click handlers
  document.querySelectorAll('.parameter-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.parameter-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      loadChart(this.dataset.param);
    });
  });

  // Load initial chart
  loadChart('ph');
});
</script>
